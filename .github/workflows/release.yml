name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"      # e.g. v1.2.3
      - "v[0-9]+.[0-9]+.[0-9]+-*"    # e.g. v1.2.3-beta.1

permissions:
  contents: write   # required to create GitHub Releases

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1: Build release binary and publish GitHub Release
  # ──────────────────────────────────────────────────────────────────────────
  release:
    name: Build & Publish Release
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0   # full history for changelog generation

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Show tool versions
        run: |
          swift --version
          xcodebuild -version

      - name: Parse version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building release for $VERSION"

      - name: Build release binary
        run: make build-release VERBOSE=1

      - name: Run tests (gate)
        run: make test VERBOSE=1

      - name: Package binary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH=$(uname -m)
          ARTIFACT="VidPare-${VERSION}-macos-${ARCH}"

          mkdir -p dist
          cp .build/release/VidPare dist/VidPare

          # Create tar.gz
          tar -czf "dist/${ARTIFACT}.tar.gz" -C dist VidPare
          # Create zip (friendlier for some users)
          cd dist && zip "${ARTIFACT}.zip" VidPare && cd ..

          echo "ARTIFACT_NAME=${ARTIFACT}" >> "$GITHUB_ENV"

      - name: Generate release notes
        id: release_notes
        run: |
          # Derive the previous tag for changelog range
          CURRENT_TAG="${{ steps.version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..${CURRENT_TAG}"
          else
            RANGE="${CURRENT_TAG}"
          fi

          {
            echo "## What's Changed"
            echo ""
            git log "$RANGE" --pretty=format:"- %s (%h)" --no-merges
            echo ""
            echo ""
            if [ -n "$PREV_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}"
            else
              echo "**Release**: https://github.com/${{ github.repository }}/releases/tag/${CURRENT_TAG}"
            fi
          } > RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          name: "VidPare ${{ steps.version.outputs.version }}"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            dist/*.tar.gz
            dist/*.zip
