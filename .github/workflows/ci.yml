name: CI

on:
  push:
    branches:
      - main
      - master
      - "claude/**"
  pull_request:
    branches:
      - main
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1: Lint with SwiftLint
  # ──────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Show tool versions
        run: |
          swift --version
          xcodebuild -version

      - name: Cache Homebrew packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-brew-swiftlint-${{ hashFiles('.swiftlint.yml') }}
          restore-keys: |
            ${{ runner.os }}-brew-swiftlint-

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: make lint-strict REPORTER=github-actions-logging

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2: Build & Test matrix across macOS 14 (M1) and macOS 15 (M2)
  # ──────────────────────────────────────────────────────────────────────────
  build-and-test:
    name: Build & Test (macOS ${{ matrix.macos }})
    runs-on: macos-${{ matrix.macos }}
    strategy:
      fail-fast: false
      matrix:
        macos: ["14", "15"]
        include:
          - macos: "14"
            xcode: "/Applications/Xcode_16.1.app"
          - macos: "15"
            xcode: "/Applications/Xcode_16.2.app"

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Select Xcode
        run: sudo xcode-select -s ${{ matrix.xcode }}

      - name: Show tool versions
        run: |
          swift --version
          xcodebuild -version
          uname -m

      - name: Cache Swift build artifacts
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: .build
          key: ${{ runner.os }}-${{ matrix.macos }}-spm-v2-${{ hashFiles('Package.swift') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.macos }}-spm-v2-${{ hashFiles('Package.swift') }}-
            ${{ runner.os }}-${{ matrix.macos }}-spm-v2-

      - name: Clean stale module cache
        run: |
          if [ -d .build ]; then
            # Remove module caches that may contain stale paths from repo rename
            find .build -name "ModuleCache" -type d -exec rm -rf {} + 2>/dev/null || true
          fi

      - name: Build (debug)
        run: make build VERBOSE=1

      - name: Build (release)
        run: make build-release VERBOSE=1

      - name: Run unit tests
        run: make test VERBOSE=1 COVERAGE=1

      - name: Generate code coverage report
        run: |
          BUILD_PATH=$(swift build --show-bin-path)

          # Locate the xctest bundle (SPM names it <Package>PackageTests.xctest)
          TEST_XCTEST=$(find "$BUILD_PATH" -maxdepth 1 -name "*.xctest" | head -1)
          if [ -z "$TEST_XCTEST" ]; then
            echo "No xctest bundle found in $BUILD_PATH"
            exit 1
          fi

          TEST_BINARY="$TEST_XCTEST/Contents/MacOS/$(basename "$TEST_XCTEST" .xctest)"
          PROF_DATA="$BUILD_PATH/codecov/default.profdata"

          echo "Test binary : $TEST_BINARY"
          echo "Prof data   : $PROF_DATA"

          xcrun llvm-cov export \
            "$TEST_BINARY" \
            -instr-profile="$PROF_DATA" \
            -format=lcov \
            -ignore-filename-regex='\.build|Tests' \
            > coverage.lcov

          echo ""
          echo "=== Coverage Summary ==="
          xcrun llvm-cov report \
            "$TEST_BINARY" \
            -instr-profile="$PROF_DATA" \
            -ignore-filename-regex='\.build|Tests'

      - name: Upload coverage to Codecov
        # Only upload from one matrix leg to avoid duplicate reports
        if: matrix.macos == '15'
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238
        with:
          file: coverage.lcov
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload debug build artifact
        if: matrix.macos == '15'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: VidPare-debug-macos${{ matrix.macos }}
          path: .build/debug/VidPare
          retention-days: 7

      - name: Upload release build artifact
        if: matrix.macos == '15'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: VidPare-release-macos${{ matrix.macos }}
          path: .build/release/VidPare
          retention-days: 7
